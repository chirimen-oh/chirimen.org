<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>I2Cデバイスを試す</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../themes/packages/@vivliostyle/theme-techbook/theme.css">
  </head>
  <body>
    <section class="level1" aria-labelledby="i2cデバイスを試す">
      <h1 id="i2cデバイスを試す">I2Cデバイスを試す</h1>
      <section class="level2" aria-labelledby="i2cの概要">
        <h2 id="i2cの概要">I2Cの概要</h2>
        <p><a href="https://ja.wikipedia.org/wiki/I2C">I2C</a> とは 2 線式の同期式シリアル通信インタフェースです。「アイ・スクエア・シー」や「アイ・ ツー・シー」と読みます。I2C では SDA（シリアルデータ）と SCL（シリアルクロック）の 2 本の線で通信を行います。</p>
        <figure>
          <img src="../../raspi/imgs/section2/i2c-bus.png" alt="i2c-bus">
          <figcaption aria-hidden="true">i2c-bus</figcaption>
        </figure>
        <p>上図のように、I2C の SDA、SCL は複数のデバイス間で共有され、これを「I2C バス」と言います。I2C ではマスターとスレーブの間で通信が行われます。常にマスター側からスレーブ側に要求が行われ、スレーブ側からマスター側へ要求を行うことはできません。</p>
        <p>本チュートリアルでいえばCHIRIMEN環境を動かすボードコンピュータがマスターとなり、ここに接続されるセンサーやアクチュエータデバイスなどがスレーブとして想定されます。スレーブデバイスの一例として紹介されているI2Cデバイス<span class="footnote">14.1 I2Cセンサー</span>をご覧ください。</p>
        <p>
          マスターは、スレーブが持つ「SlaveAddress (スレーブアドレス)」を指定して、特定のスレーブとの通信を行います。このため、同じ I2C バス上に同じ SlaveAddress のスレーブを繋ぐことはできません。
          I2Cデバイスは小型のICチップデバイスとなっており、デバイスによってはSlaveAddressは製品ごとに固定されています。
        </p>
        <figure>
          <img src="../../raspi/imgs/section2/i2c-bus2.png" alt="i2c-bus2">
          <figcaption aria-hidden="true">i2c-bus2</figcaption>
        </figure>
        <p>通信するデバイス同士が同一基板上にない場合には、SDA、SCL の 2 本の通信線に加え電源や GND の線を加えて 4 本のケーブルを用いて接続するのが一般的です。電源電圧はデバイスに応じたものを繋ぐ必要があります。</p>
        <section class="level3" aria-labelledby="raspverry-pi-zeroのi2c端子">
          <h3 id="raspverry-pi-zeroのi2c端子">Raspverry Pi ZeroのI2C端子</h3>
          <p>下図のSCL, SDAがI2C端子です</p>
          <figure>
            <img src="../../raspi/imgs/section0/Raspi3PIN.png" alt="Raspberry Pi PIN配置図" height="600">
            <figcaption aria-hidden="true">Raspberry Pi PIN配置図</figcaption>
          </figure>
          <p>Raspberry PiのI2C端子と同じ配列です。</p>
          <hr class="page-wrap">
        </section>
      </section>
      <section class="level2" aria-labelledby="ポイント">
        <h2 id="ポイント">ポイント</h2>
        <p>I2C の概要として下記を押さえておきましょう。</p>
        <ul>
          <li>I2C バスを介して複数のデバイスが繋がる</li>
          <li>I2C デバイスにはマスターとスレーブがある</li>
          <li>I2C ではマスターからスレーブに対して通信要求が行われる</li>
          <li>I2C スレーブは SlaveAddress を持つ</li>
          <li>同じ I2C バスに同じ SlaveAddress のデバイスは繋げない</li>
        </ul>
        <section class="level3" aria-labelledby="i2cデバイスモジュールの接続について">
          <h3 id="i2cデバイスモジュールの接続について">I2Cデバイスモジュールの接続について</h3>
          <p>I2Cデバイスは一般的に小さなチップ部品です。下の拡大写真で下の枠線で囲んだものがSHT31の本体で 上下に出ている微細な端子を接続して使いますが、微細過ぎてプロトタイピングには向きません。そこでブレッドボードで使いやすい端子に変換したモジュールが販売されています。モジュールには<strong>上の枠線囲んだように端子名の記載</strong>があります。これを<strong>ホストのコンピュータの端子名と一致させて結線</strong>することでI2Cデバイスが正しく接続されます。(電源端子はVIN,V+,3V,VCCなど別名になっていることがあります)</p>
          <figure>
            <img src="../../microbit/imgs/SHT31ModulePin.jpg" alt="I2Cmodule" height="120">
            <figcaption aria-hidden="true">I2Cmodule</figcaption>
          </figure>
          <section class="note" role="doc-note">
            <section class="level4" aria-labelledby="注意-配線時のポイント">
              <h4 id="注意-配線時のポイント">注意: 配線時のポイント</h4>
              <pre class="language-text"><code class="language-text">配線の接続先やデバイスの基板の表裏など間違えないように注意してください。
配線を間違えると、故障や怪我などの原因になることがあります。おかしいなと思ったら、すぐに外して、配線をきちんと確認しましょう。</code></pre>
            </section>
          </section>
        </section>
      </section>
      <section class="level2" aria-labelledby="i2cdetectで接続がうまくいったか確認する">
        <h2 id="i2cdetectで接続がうまくいったか確認する">i2cdetectで接続がうまくいったか確認する</h2>
        <p>
          <code>i2cdetect</code> を使って SlaveAddress を確認し、正しく接続・認識できているか確かめられます。
          実際に次節以降の使用例で利用しますが、ここではコマンドの操作方法を解説します。
        </p>
        <section class="level3" aria-labelledby="コマンドラインから">
          <h3 id="コマンドラインから">コマンドラインから</h3>
          <p>ターミナルを起動して下記コマンドを入力してみてください。</p>
          <pre class="language-sh"><code class="language-sh">i2cdetect -y -r 1</code></pre>
        </section>
        <section class="level3" aria-labelledby="i2cdetect-webapp">
          <h3 id="i2cdetect-webapp">i2cdetect webApp</h3>
          <p>Raspberry PiZeroWでは、<a href="https://chirimen.org/PiZeroWebSerialConsole/PiZeroWebSerialConsole.html">ターミナルウィンド</a> ⇒ CHIRIMEN Panel ⇒ i2c detect　でコマンドラインのショートカットが使えます。</p>
        </section>
        <section class="level3" aria-labelledby="i2c-detectの結果">
          <h3 id="i2c-detectの結果">i2c detectの結果</h3>
          <p>正しく接続できていれば下記のように表示されるはずです。</p>
          <pre class="language-text"><code class="language-text">$ i2cdetect -y -r 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- 44 -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --</code></pre>
          <p><code>44</code>という表示が見えます。これは 16 進数表示であり、 <code>0x44</code> は SHT30 の SlaveAddress です。</p>
          <p>念のためSHT30のデータシートも確認してみましょう。</p>
          <blockquote>
            <table>
              <thead>
                <tr>
                  <th>SHT3x-DIS</th>
                  <th>I2C Address in Hex. representation</th>
                  <th>Condition</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>I2C address A</td>
                  <td>0x44 (default)</td>
                  <td>ADDR (pin 2) connected to logic low</td>
                </tr>
                <tr>
                  <td>I2C address B</td>
                  <td>0x45</td>
                  <td>ADDR (pin 2) connected to logic high</td>
                </tr>
              </tbody>
            </table>
            <p><strong>Table 8 I2C device addresses.</strong></p>
            <p><a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">SHT30 のデータシート p.9</a>より引用</p>
          </blockquote>
          <p>SHT30 は<code>0x44</code>がデフォルトの SlaveAddress で、ADDR ピンの HIGH/LOW により SlaveAddeess を <code>0x44</code> か <code>0x45</code> に変更できることがわかります。</p>
          <hr class="page-wrap">
        </section>
        <section class="level3" aria-labelledby="認識されないとき">
          <h3 id="認識されないとき">認識されないとき</h3>
          <p>
            試しに I2C デバイスへの電源供給を止めて、認識されないケースをあえて確かめてみます。
            一度 Raspberry Pi の 3.3V に接続している線を抜いて、もう一度 <code>i2cdetect -y -r 1</code> を実行してみてください。
          </p>
          <pre class="language-text"><code class="language-text">$ i2cdetect -y -r 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --</code></pre>
          <p>
            <code>44</code> という表示が見つからなくなりました。このことによって間違いなく SHT30 の SlaveAddress が <code>0x44</code> となっていることを確認できました。
            確認できたら、先ほど外した 3.3V の線を戻して再び SHT30 に電源を供給して認識されるようにしておきましょう。
          </p>
        </section>
      </section>
      <section class="level2" aria-labelledby="webi2cとデバイスドライバ">
        <h2 id="webi2cとデバイスドライバ">WebI2Cとデバイスドライバ</h2>
        <p>CHIRIMENでは、GPIOインターフェースをWeb GPIOと呼ぶAPIで使用しました。I2Cインターフェースに接続されたスレーブデバイスは<a href="http://browserobo.github.io/WebI2C">Web I2C API</a>と呼ぶAPIによって使用することができます。</p>
        <p>
          しかしI2CスレーブデバイスはGPIOの先に繋げるデバイスと比べてずっと複雑な機能を持っています。実際にはそれは極小のコンピュータで、I2Cを通しデバイス専用のコマンドやデータを送受信（通信）し、固有の機能を利用します。
          このようなコードは、各デバイスのデータシートをよく読み込んだうえで書くことができます。これはかなり手間のかかる開発ですので簡単にデバイスが使用できるライブラリ(デバイスドライバ)があらかじめ用意されています。
        </p>
        <section class="level3" aria-labelledby="デバイスドライバが用意されているi2cデバイスのリスト">
          <h3 id="デバイスドライバが用意されているi2cデバイスのリスト">デバイスドライバが用意されているI2Cデバイスのリスト</h3>
          <p>デバイスドライバが用意され簡単に利用できるI2Cデバイスのリスト<span class="footnote">14.1 I2Cセンター</span></p>
          <p>よく利用される、30種類ぐらいの比較的安価なデバイス向けのドライバが用意されています。</p>
          <hr class="page-wrap">
        </section>
      </section>
      <section class="level2" aria-labelledby="i2c-温湿度センサーの使用例">
        <h2 id="i2c-温湿度センサーの使用例">I2C 温湿度センサーの使用例</h2>
        <section class="level3" aria-labelledby="sht30-sht31について">
          <h3 id="sht30-sht31について">SHT30, SHT31について</h3>
          <ul>
            <li><a href="http://akizukidenshi.com/catalog/g/gK-12125/">湿度・温度センサ (SHT31)</a> x 1
              <ul>
                <li>または SHT30 (<a href="https://www.amazon.co.jp/s?k=sht30">Amazon</a>, <a href="https://ja.aliexpress.com/item/32962846003.html">AliExpress</a>)。</li>
                <li>note: SHT31 は氷点下や 65 度以上などの高温での計測時の精度が SHT30 よりも少し高いが室温程度ではほぼ同様の類似モデルです。同シリーズには他にも SHT35 などもありますがそちらは未検証です。 (参考: <a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">データシート</a>)</li>
              </ul>
            </li>
          </ul>
        </section>
        <section class="level3" aria-labelledby="sht30編">
          <h3 id="sht30編">SHT30編</h3>
          <p>SHT30は温度に加えて湿度も測定できるI2C接続の多機能センサーです。SHT31もほぼ同等に使えます。(SHT31のほうが精度が高い)</p>
          <ul>
            <li>ターミナルウィンドの<code>[CHIRIMEN Panel]</code>ボタンを押す</li>
            <li>出現したCHIRIMEN Panelの<code>[Get Examples]</code>ボタンを押す</li>
            <li>ID : sht30を探します</li>
            <li>回路図リンクを押すと回路図が出てきますので、回路を組みます。なお、接続は下の図のようになります。</li>
          </ul>
          <figure>
            <img src="../../pizero/esm-examples/sht30/schematic.png" alt="SHT31 schematic" height="220">
            <figcaption aria-hidden="true">SHT31 schematic</figcaption>
          </figure>
          <ul>
            <li><code>[JS GET]</code>ボタンを押すと、開発ディレクトリ(<code>~/myApp</code>)に、サンプルコードが保存されます。
              <ul>
                <li><strong>main-sht30.js</strong>というファイル名で保存されます。</li>
                <li>Note: ターミナルウィンドの右側のファイルマネージャでmain-sht30.js⇒編集 を選ぶと、エディタで編集できます。
                  <ul>
                    <li>ソースコードを見てみましょう</li>
                    <li>今は編集不要ですが、サンプルをベースに応用プログラムを作るときには編集しましょう。</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <section class="level4" aria-labelledby="i2cセンサーsht30が認識されていることを確認する">
            <h4 id="i2cセンサーsht30が認識されていることを確認する">I2Cセンサー(SHT30)が認識されていることを確認する</h4>
            <ul>
              <li>CHIRIMEN Panelの<code>[i2c detect]</code>ボタンを押すと、<a href="https://strawberry-linux.com/pub/Sensirion_Humidity_SHT3x_DIS_Datasheet_V3_J.pdf">SHT30のI2Cアドレス</a>　0x<strong>44</strong>が表示されていればうまく接続されています。</li>
            </ul>
            <pre>     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- 44 -- -- -- -- -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                       
</pre>
          </section>
          <section class="level4" aria-labelledby="実行する">
            <h4 id="実行する">実行する</h4>
            <ul>
              <li>ターミナルウィンドのコンソールのプロンプトが<code>pi@raspberrypi:~/myApp$</code>となっていることを確認</li>
              <li>ターミナルウィンドのコンソールに、<code>node main-sht30.js</code> [ENTER] と入力して実行。</li>
              <li>温度と湿度が1秒ごとにコンソールに表示されます。</li>
              <li>終了は CTRL+c</li>
            </ul>
          </section>
          <section class="level4" aria-labelledby="コードを読む">
            <h4 id="コードを読む">コードを読む</h4>
            <ul>
              <li>ターミナルウィンドの右側のファイルマネージャでmain-sht30.js⇒表示 を選び、ソースコードを読んでみましょう</li>
            </ul>
            <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>requestI2CAccess<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./node_modules/node-web-i2c/index.js"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token constant">SHT30</span> <span class="token keyword module">from</span> <span class="token string">"@chirimen/sht30"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">msec</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> msec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> i2cAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">requestI2CAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> i2cAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sht30 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SHT30</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> humidity<span class="token punctuation">,</span> temperature <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Humidity: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>humidity<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Temperature: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>temperature<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> degree</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
            <section class="level5" aria-labelledby="webi2cライブラリとsht30デバイスドライバを読み込む">
              <h5 id="webi2cライブラリとsht30デバイスドライバを読み込む">WebI2CライブラリとSHT30デバイスドライバを読み込む</h5>
              <p>
                <code>node-web-i2c</code> は WebI2C API を使用できるようにするためのライブラリです。
                <code>@chirimen/sht30</code> は、Web I2C API を使って SHT30 との通信を行うための、SHT30用のデバイスドライバー (ハードウェアを操作する為のライブラリ) です。
                <code>main.js</code> がドライバーライブラリを使ってこのアプリケーションの動作を記述している部分です。
              </p>
              <p>
                次に、<code>main.js</code> の処理の流れを見てみましょう。
                ここで温度センサーの情報を定期的に取得し、画面に出力する処理が行われています。
                少し詳しく解説してみます。
              </p>
            </section>
            <section class="level5" aria-labelledby="await-requesti2caccess">
              <h5 id="await-requesti2caccess">await requestI2CAccess()</h5>
              <p>Web I2C API を利用するための <strong><code>I2CAccess</code> インタフェースを取得</strong> するための最初の API 呼び出しです。この関数も非同期処理ですので <code>await</code> で処理完了を待機し、その結果正しくインタフェースが取得されたら <code>i2cAccess</code> オブジェクトに保持します。</p>
            </section>
            <section class="level5" aria-labelledby="i2caccessportsget">
              <h5 id="i2caccessportsget">i2cAccess.ports.get()</h5>
              <p><code>I2CAccess.ports</code> は、利用可能な I2C ポートの一覧です。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> port <span class="token operator">=</span> i2cAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>CHIRIMEN Raspberry Pi、Raspberry PiZero、で利用可能な I2C ポート番号は<code>1</code>番だけです。ポート番号に<code>1</code> を指定して <strong><code>port</code> オブジェクトを取得</strong> しています。</p>
            </section>
            <section class="level5" aria-labelledby="new-sht30port-0x44">
              <h5 id="new-sht30port-0x44">new SHT30(port, 0x44)</h5>
              <p>ドライバーライブラリを使い <strong>SHT30 を操作する為のインスタンスを生成</strong> しています。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> sht30 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SHT30</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
            </section>
            <section class="level5" aria-labelledby="await-sht30init">
              <h5 id="await-sht30init">await sht30.init()</h5>
              <p>ドライバーライブラリのインスタンス (<code>sht30</code>) の <code>init()</code> メソッドを通じて <strong>I2C ポートを開いてセンサーを初期化</strong> しています。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>具体的に内部では、インスタンス生成時に指定した <code>port</code> オブジェクトと <code>slaveAddress(0x44)</code> を用いて <code>I2CPort.open()</code> を行なっています。<code>I2CPort.open()</code> が成功すると、<code>I2CSlaveDevice</code> という I2C ポートへデータ書き込みや読み込みなどを行うインタフェースが返されます。<code>I2CSlaveDevice</code> インタフェースは、ライブラリ内に保存され、その後の処理でこのインターフェイスを使って I2C デバイス SHT30 との通信が可能になります。</p>
            </section>
            <section class="level5" aria-labelledby="await-sht30readdata">
              <h5 id="await-sht30readdata">await sht30.readData()</h5>
              <p>これで実際にデータを読み取っています。 この読み取り関数はGPIOで紹介した、一回きりの単純入力に相当するものです。そのため連続的な変化を知りたい場合はポーリングルーチンを組む必要がありますね。</p>
              <p><strong>SHT30 の仕様に基づくデータ読み出し処理です</strong>。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> humidity<span class="token punctuation">,</span> temperature <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>ドライバーライブラリ内部では、SHT30 から得られる温度と湿度それぞれ 16bit の数値を、温度・湿度の物理量の数値に変換して返却しています。</p>
            </section>
          </section>
          <section class="level4" aria-labelledby="web-i2c-api-に着目して流れをまとめると">
            <h4 id="web-i2c-api-に着目して流れをまとめると">Web I2C API に着目して流れをまとめると</h4>
            <ol>
              <li><strong>I2C の準備:</strong> <code>await requestI2CAccess()</code> で I2CAccess インタフェースを取得</li>
              <li><strong>ポートの準備:</strong> <code>await i2cAccess.ports.get(1)</code> で、1 番ポートの <code>port</code> オブジェクトを取得</li>
              <li><strong>デバイス初期化:</strong> <code>await port.open(0x44)</code> で、SlaveAddress <code>0x44</code> 番の I2CSlaveDevice インタフェースを取得</li>
              <li><strong>データ読み込み・書き込み:</strong></li>
            </ol>
            <p>この流れは他の I2C デバイスでも基本的に同様になります。</p>
          </section>
        </section>
        <section class="level3" aria-labelledby="デバイスドライバーなしにsht30を使う">
          <h3 id="デバイスドライバーなしにsht30を使う">デバイスドライバーなしにSHT30を使う</h3>
          <p>デバイスドライバーはI2Cデバイスを簡単に使えるようにするライブラリでしかありませんので、ライブラリなしにWebI2CAPIを用いて直接デバイスを使うこともできます。運悪くデバイスドライバーが用意されていないI2Cデバイスを使いたい場合や、デバイスドライバーで省略されている機能を使いたい場合などのために、<a href="http://browserobo.github.io/WebI2C">Web I2C API</a>の振る舞いを理解しておきましょう。</p>
          <p>まず、デバイスドライバーなしに使うにはそのデバイスのデータシートをよく読み込みながら開発する必要があります。</p>
          <p>それでは<a href="https://github.com/chirimen-oh/chirimen-drivers/tree/master/packages/sht30/sht30.js">SHT30ドライバのコード</a>を見てみましょう。</p>
          <ul>
            <li>初期化 <code>init()</code></li>
          </ul>
          <pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">{</span>
		slaveAddress <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
          <p><a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">SHT30データシート</a> の９ページに記載の通り、ドライバでは指定がない場合スレーブアドレス0x44を指定して通信を開始しています。</p>
          <ul>
            <li>データの読み取り <code>readData()</code></li>
          </ul>
          <pre class="language-js"><code class="language-js"><span class="token comment">// 単発高精度計測指示コマンドをi2cインターフェースに送信（</span>
<span class="token comment">// データシート９～１０ページ、及び２ページ（計測精度スペック））</span>
<span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">i2cSlave</span><span class="token punctuation">.</span><span class="token method function property-access">write8</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 計測完了の待機時間(100ms)</span>
<span class="token comment">//（データシート７ページ～15ms以上の待機）</span>
<span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// i2cインターフェースから、６バイトの計測データを読み取り</span>
<span class="token comment">//（データシート１０ページ）</span>
<span class="token keyword">var</span> mdata <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">i2cSlave</span><span class="token punctuation">.</span><span class="token method function property-access">readBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 計算式（データシート１４ページ）に従い温度（摂氏）を算出</span>
<span class="token keyword">var</span> cTemp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> mdata<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">175</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65535.0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">45</span><span class="token punctuation">;</span>
<span class="token comment">// 同様に湿度（％）を算出</span>
<span class="token keyword">var</span> humidity <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mdata<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> mdata<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65535.0</span><span class="token punctuation">;</span></code></pre>
          <p>ドライバーライブラリ内部では、上記のようにSHT30 に単発の高精度計測を指示し、得られた温度と湿度それぞれ 16bit の数値を、温度・湿度の物理量の浮動小数点数に変換して返却しています。</p>
        </section>
        <section class="level3" aria-labelledby="adt7410編">
          <h3 id="adt7410編">ADT7410編</h3>
          <p>
            温度センサーADT7410を使います。
            もし、SHT30を使用する場合は、「IoTを試す」の章まで読み飛ばしてください。
          </p>
          <ul>
            <li>ターミナルウィンドの<code>[CHIRIMEN Panel]</code>ボタンを押す</li>
            <li>出現したCHIRIMEN Panelの<code>[Get Examples]</code>ボタンを押す</li>
            <li>ID : adt7410を探します(上から5個目ぐらい)</li>
            <li>回路図リンクを押すと回路図が出てきますので、回路を組みます。なお、接続は下の図のようになります。</li>
          </ul>
          <figure>
            <img src="../../pizero/imgs/pizero_temp.png" alt="PiZero温度センサー図">
            <figcaption aria-hidden="true">PiZero温度センサー図</figcaption>
          </figure>
          <ul>
            <li><code>[JS GET]</code>ボタンを押すと、開発ディレクトリ(<code>~/myApp</code>)に、サンプルコードが保存されます。
              <ul>
                <li><strong>main-adt7410.js</strong>というファイル名で保存されます。</li>
                <li>Note: ターミナルウィンドの右側のファイルマネージャでmain-adt7410.js⇒編集 を選ぶと、エディタで編集できます。
                  <ul>
                    <li>ソースコードを見てみましょう</li>
                    <li>今は編集不要ですが、サンプルをベースに応用プログラムを作るときには編集しましょう。</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <section class="note break-after-page" role="doc-note">
            <section class="level4" aria-labelledby="センサーの極性に注意">
              <h4 id="センサーの極性に注意">センサーの極性に注意</h4>
              <pre class="language-text"><code class="language-text">温度センサー ADT7410 を用意した場合、図と同じように配線します。配線(特に電源線)を間違えるとセンサーが高熱になり火傷・破損するので注意してください。</code></pre>
            </section>
          </section>
        </section>
        <section class="level3" aria-labelledby="i2cセンサーが認識されていることを確認する">
          <h3 id="i2cセンサーが認識されていることを確認する">I2Cセンサーが認識されていることを確認する</h3>
          <ul>
            <li>CHIRIMEN Panelの<a href="https://tutorial.chirimen.org/ty51822r3/i2cdetect"><code>[i2c detect]</code></a>ボタンを押すと、<a href="https://akizukidenshi.com/download/ds/akizuki/AE-ADT7410_aw.pdf">ADT7410のI2Cアドレス</a>　0x<strong>48</strong>が表示されていればうまく接続されています。</li>
          </ul>
          <pre>     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
40: -- -- -- -- -- -- -- -- 48 -- -- -- -- -- -- -- 
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
70: -- -- -- -- -- -- -- --                       
</pre>
        </section>
        <section class="level3" aria-labelledby="実行する-1">
          <h3 id="実行する-1">実行する</h3>
          <ul>
            <li>ターミナルウィンドのコンソールのプロンプトが<code>pi@raspberrypi:~/myApp$</code>となっていることを確認</li>
            <li>ターミナルウィンドのコンソールに、<code>node main-adt7410.js</code> [ENTER] と入力して実行。</li>
            <li>温度が1秒ごとにコンソールに表示されます。</li>
            <li>終了は CTRL+c</li>
          </ul>
        </section>
      </section>
    </section>
  </body>
</html>
