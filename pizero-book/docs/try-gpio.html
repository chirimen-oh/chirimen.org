<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>GPIOを試す</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../themes/packages/@vivliostyle/theme-techbook/theme.css">
  </head>
  <body>
    <section class="level1" aria-labelledby="gpioを試す">
      <h1 id="gpioを試す">GPIOを試す</h1>
      <section class="level2" aria-labelledby="gpioとは">
        <h2 id="gpioとは">GPIOとは</h2>
        <p><a href="https://ja.wikipedia.org/wiki/GPIO">GPIO</a>は、「General-purpose input/output」の略で汎用的な入出力インタフェースのことです。</p>
        <p>Raspi に実装されている 40 本のピンヘッダから GPIO を利用することができます。</p>
        <p>CHIRIMEN Raspi、Raspi Zero では Raspi が提供する 40 本のピンヘッダ<span class="footnote">3.1 Raspberry Pi Zeroのピン配列</span>のうち、GPIO端子(合計 17 本)が利用可能です。</p>
        <p>Raspiの GPIO 端子は、GND 端子との間に、0V もしくは 3.3V の電圧を印加(出力)したり、逆に 0V もしくは 3.3V の電圧を検知(入力)したりすることができます。LED は数 mA の電流を流すことによって点灯できる電子部品のため、印加する電圧を 3.3V(点灯)、0V(消灯) と変化させることで L チカが実現できるのです。</p>
        <p>詳しくは<a href="https://tool-lab.com/make/raspberrypi-startup-22/">ツール・ラボ/第22回 Raspberry PiのGPIO概要</a>などを参考にしてみましょう。</p>
        <section class="level3" aria-labelledby="プルアップpuプルダウンpd">
          <h3 id="プルアップpuプルダウンpd">プルアップ(PU)、プルダウン(PD)</h3>
          <p>
            GPIOポートを入力モードで使用する場合、ポートが解放状態(電気的に切り離されている状態)のときに設定される値があります。
            プルアップは1、プルダウンは0になります。　Raspberry Piのピン配置図に書かれているPU,PDがその設定値です。
          </p>
          <p>より詳しく知りたい場合は <a href="https://voltechno.com/blog/pullup-pulldown/">プルアップ抵抗・プルダウン抵抗とは？電子回路に必須の考え方/voltechno</a> を参照してください。</p>
          <hr class="page-wrap">
        </section>
      </section>
      <section class="level2" aria-labelledby="gpio出力">
        <h2 id="gpio出力">GPIO出力</h2>
        <p>GPIOの出力はLチカで実験済みですね。そこで今回はモーターを動かしてみましょう。MOSFET<span class="footnote">13 章の参考リンクから該当情報を参照ください</span>を使った回路図は以下のようになります。</p>
        <figure>
          <img src="../../pizero/esm-examples/hello-real-world/PiZero_gpio0Motor.png" alt="GPIO Motor" height="190">
          <figcaption aria-hidden="true">GPIO Motor</figcaption>
        </figure>
        <p>コードはLチカと全く同じです。</p>
        <section class="level3" aria-labelledby="コードを読む">
          <h3 id="コードを読む">コードを読む</h3>
          <p>ターミナルウィンドの右側のファイルマネージャでhello.js⇒表示 を選び、ソースコードを読んでみましょう</p>
          <section class="level4" aria-labelledby="webgpioライブラリを読み込む">
            <h4 id="webgpioライブラリを読み込む">WebGPIOライブラリを読み込む</h4>
            <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>requestGPIOAccess<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./node_modules/node-web-gpio/dist/index.js"</span><span class="token punctuation">;</span></code></pre>
            <p>JavaScript module<span class="footnote">10.2.3. javascript Module (ECMA Script Module)参照</span>に基づいてWebGPIOライブラリを読み込みます。これでWeb GPIO APIが使えるようになりました。</p>
          </section>
          <section class="level4" aria-labelledby="gpioポートの初期化">
            <h4 id="gpioポートの初期化">GPIOポートの初期化</h4>
            <p>
              今回の JavaScript ファイルで、最初に呼び出されるコードは <code>await navigator.requestGPIOAccess()</code> です。
              ここで先ほど出て来た <a href="http://browserobo.github.io/WebGPIO">Web GPIO API</a> を使い、<code>gpioAccess</code> という GPIO にアクセスするためのインタフェースを取得しています。
            </p>
            <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> gpioAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token method function property-access">requestGPIOAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPIO を操作する</span></code></pre>
            <section class="note break-before-page" role="doc-note">
              <section class="level5" aria-labelledby="関数の呼び出しに-await-接頭詞を付けることに注意">
                <h5 id="関数の呼び出しに-await-接頭詞を付けることに注意">関数の呼び出しに <code>await</code> 接頭詞を付けることに注意</h5>
                <p>この関数は非同期関数で、その処理の完了を待ってから次の処理をする必要があります。また、<code>await</code> 接頭詞を使うコードを含むために、それを含む関数 <code>main()</code> は async 接頭詞付きの非同期関数として定義する必要があります。</p>
              </section>
            </section>
          </section>
          <section class="level4" aria-labelledby="gpioport-の出力処理">
            <h4 id="gpioport-の出力処理">GPIOPort の出力処理</h4>
            <p>
              GPIOの<strong>出力</strong>機能を使います。
              <strong><code>const port = gpioAccess.ports.get(26)</code> で GPIO の 26 番ポートにアクセスするためのオブジェクト</strong> を取得しています。
            </p>
            <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> port <span class="token operator">=</span> gpioAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 26 番ポートを操作する</span></code></pre>
            <p>続いて、 <strong><code>await port.export("out")</code> で GPIO の 26 番を「出力設定」にしています</strong>。これにより LED への電圧の切り替えが可能になっています。</p>
            <pre class="language-js"><code class="language-js"><span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token punctuation">(</span><span class="token string">"out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ポートを出力モードに設定</span></code></pre>
            <p>最後に、無限ループのなかで <code>await sleep(1000)</code> によって 1000 ms (1 秒) 待機さ 1 秒ごとに <code>await port.write(1)</code> と <code>await port.write(0)</code> を交互に呼び出し、GPIO 26 番に加える電圧を 3.3V → 0V → 3.3V → 0V → … と繰り返しています。</p>
            <pre class="language-js"><code class="language-js">  <span class="token comment">// 無限ループ</span>
  <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1秒間隔でモーターが回転します。</span>
    <span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// モーターを回転</span>
    <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000 ms (1秒) 待機</span>
    <span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// モーターを停止</span>
    <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1000 ms (1秒) 待機</span>
  <span class="token punctuation">}</span></code></pre>
            <p>
              LED やモーターは一定以上の電圧を加え、電流を流すと動作（点灯/回転）する性質を持っています。
              つまり、3.3 V を加えたとき動作し、0 V を加えたとき停止、これを繰り返すことになります。
            </p>
          </section>
        </section>
        <section class="level3" aria-labelledby="サンプルコードを編集してみよう">
          <h3 id="サンプルコードを編集してみよう">サンプルコードを編集してみよう</h3>
          <ul>
            <li>周期を早く・遅く (<code>sleep()</code>の引数を変更)</li>
            <li>動作する時間と停止する時間を変える (同上)</li>
            <li>GPIO ポートを他のポートに変える・配線を変える (<code>gpioAccess.ports.get</code>の引数を変更)</li>
          </ul>
          <hr class="page-wrap">
        </section>
      </section>
      <section class="level2" aria-labelledby="gpio入力">
        <h2 id="gpio入力">GPIO入力</h2>
        <p>GPIO端子の<strong>入力が変化したら関数を実行</strong>という機能によってGPIOの入力を使います。</p>
        <p>GPIOポートに繋いだスイッチやセンサーの状態を取得するには、GPIOの<strong>入力</strong>機能を使います。出力とは違って入力は二つの方法があります。onchangeとポーリングの二つの方法があります。</p>
        <figure>
          <img src="../../pizero/esm-examples/gpio-onchange/PiZero_gpio1.png" alt="GPIOスイッチ (GPIO INPUT)" height="190">
          <figcaption aria-hidden="true">GPIOスイッチ (GPIO INPUT)</figcaption>
        </figure>
        <section class="level3" aria-labelledby="onchange編">
          <h3 id="onchange編">onchange編</h3>
          <ul>
            <li>ターミナルウィンドの<code>[CHIRIMEN Panel]</code>ボタンを押す</li>
            <li>出現したCHIRIMEN Panelの<code>[Get Examples]</code>ボタンを押す</li>
            <li>ID : <strong>gpio-onchange</strong>を探します</li>
            <li>回路図リンクを押すと回路図が出てきますので、回路を組みます。</li>
            <li><code>[JS GET]</code>ボタンを押すと、開発ディレクトリ(<code>~/myApp</code>)に、サンプルコードが保存されます。
              <ul>
                <li><strong>main-gpio-onchange.js</strong>というファイル名で保存されます。</li>
                <li>ターミナルウィンドの右側のファイルマネージャでmain-gpio-onchange.js⇒編集 を選びます。
                  <ul>
                    <li>今回は編集不要ですが、サンプルをベースに応用プログラムを作るときには編集しましょう。</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <section class="level4" aria-labelledby="コードを読む-1">
            <h4 id="コードを読む-1">コードを読む</h4>
            <p>GPIOポートの値が変化するたびに、指定した関数が実行されます。</p>
            <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>requestGPIOAccess<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./node_modules/node-web-gpio/dist/index.js"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">msec</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> msec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">switchCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> gpioAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">requestGPIOAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> gpioAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token punctuation">(</span><span class="token string">"in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  port<span class="token punctuation">.</span><span class="token property-access">onchange</span> <span class="token operator">=</span> showPort<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">showPort</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">switchCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
            <p><code>port.onchange</code> は <strong>入力モードの GPIO ポートの「状態変化時に呼び出される関数を設定する」</strong> 機能です。<br>このような関数のことをコールバック関数と呼びます。<br>次節の「GPIO入力(ポーリング)」と異なりポーリング処理が不要でコードも簡潔ですが、値が変化したタイミング以外では読み取りができませんのでユースケースが少し限られます。</p>
          </section>
          <section class="level4" aria-labelledby="実行する">
            <h4 id="実行する">実行する</h4>
            <ul>
              <li>ターミナルウィンドのコンソールのプロンプトが<code>pi@raspberrypi:~/myApp$</code>となっていることを確認</li>
              <li>ターミナルウィンドのコンソールに、<code>node main-gpio-onchange.js</code> [ENTER] と入力して実行。</li>
              <li>タクトスイッチを押してみます。</li>
              <li>タクトスイッチが押されるたびにコンソール画面に<strong>0</strong>(押された状態)、<strong>1</strong>(離した状態)が交互に表示されます。
                <ul>
                  <li>Note: GPIOポート5は、Pull-Up(開放状態でHighレベル)です。そのため離した状態で１が出力されます。スイッチを押すとポートがGNDと接続され、Lowレベルになり、0が出力されます。</li>
                </ul>
              </li>
              <li>終了は CTRL+c</li>
            </ul>
          </section>
        </section>
        <section class="level3" aria-labelledby="ポーリング">
          <h3 id="ポーリング">ポーリング</h3>
          <p>入力ではイベントの他にポーリングというテクニックが広く使われます。（次章のI2Cデバイスからの入力では専らポーリング）</p>
          <ul>
            <li>ターミナルウィンドの<code>[CHIRIMEN Panel]</code>ボタンを押す</li>
            <li>出現したCHIRIMEN Panelの<code>[Get Examples]</code>ボタンを押す</li>
            <li>ID : <strong>gpio-polling</strong>を探します</li>
            <li>回路は <code>onchange編</code> と同じなのでそのままにしておきます。</li>
            <li><code>[JS GET]</code>ボタンを押すと、開発ディレクトリ(<code>~/myApp</code>)に、サンプルコードが保存されます。
              <ul>
                <li><strong>main-gpio-polling.js</strong>というファイル名で保存されます。</li>
                <li>ターミナルウィンドの右側のファイルマネージャでmain-gpio-polling.js⇒編集 を選びソースコードを見てみましょう</li>
              </ul>
            </li>
          </ul>
          <section class="note" role="doc-note">
            <section class="level4" aria-labelledby="ポーリングとは">
              <h4 id="ポーリングとは">ポーリングとは</h4>
              <p>
                様々な情報や値の取得や入力のための基本的な機能・関数は、入力を指定した瞬間、一回きり取得するだけのものがほとんどです。そこで、無限ループをつくりこの中で一回きりの入力を定期的に繰り返すことで、入力の変化を読み取る　ということがよく行われます。このような処理を一般にポーリング<span class="footnote"><a href="https://ja.wikipedia.org/wiki/%E3%83%9D%E3%83%BC%E3%83%AA%E3%83%B3%E3%82%B0_(%E6%83%85%E5%A0%B1)">https://ja.wikipedia.org/wiki/ポーリング_(情報)</a></span>と呼びます。
                ポーリングはセンサーの情報入力だけでなく、たとえば電子メールの到着を通知するために定期的にメールサーバにメール着信数を確認する　といった、ネットワークサービスでの処理など様々なシステムで広く使われています。
              </p>
            </section>
          </section>
          <section class="level4" aria-labelledby="コードを読む-2">
            <h4 id="コードを読む-2">コードを読む</h4>
            <section class="level5" aria-labelledby="gpioの単純入力関数">
              <h5 id="gpioの単純入力関数">GPIOの単純入力関数</h5>
              <p>単純に「GPIO ポートの状態を読み込む」には <code>port.read()</code> を使います。</p>
              <p><code>port.read()</code> で GPIO を読み込むコードは次のように書けます:</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> gpioAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token method function property-access">requestGPIOAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> switchPort <span class="token operator">=</span> gpioAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPIO ポート 5 番を取得</span>
<span class="token keyword control-flow">await</span> switchPort<span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token punctuation">(</span><span class="token string">"in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 「入力モード」に</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword control-flow">await</span> switchPort<span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// GPIO ポート 5 番に接続したスイッチの状態を読み込む</span></code></pre>
              <section class="level6" aria-labelledby="await-portexport">
                <h6 id="await-portexport">await port.export()</h6>
                <p><code>port.export("in")</code> により取得した <strong>GPIO ポートを「入力モード」で初期化</strong> しています。このモードは GPIO ポートにかかる電圧を Web アプリ側から読み取りたい時に使います。初期化は非同期処理であり <code>await</code> で完了を待つ必要があることに注意してください。</p>
              </section>
              <section class="level6" aria-labelledby="await-portread">
                <h6 id="await-portread">await port.read()</h6>
                <p><code>port.export("in")</code> で入力モードに設定した <strong>GPIO ポートの現時点の状態を読み取ります</strong>。読み取りは非同期処理になるので <code>await</code> で完了を待つようにしてください。</p>
              </section>
            </section>
            <section class="level5" aria-labelledby="ポーリングルーチン">
              <h5 id="ポーリングルーチン">ポーリングルーチン</h5>
              <p>上記コードで GPIO ポートの読み取りを 1 度だけ行えますが、今回は「スイッチが押され状態を監視する」必要がありますので、定期的に <code>await port.read()</code> を繰り返して GPIO ポートの状態を監視するポーリングのルーチンを組みます。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>requestGPIOAccess<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./node_modules/node-web-gpio/dist/index.js"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token parameter">msec</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> msec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">switchCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> gpioAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">requestGPIOAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> gpioAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token punctuation">(</span><span class="token string">"in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 無限ループ</span>
  <span class="token keyword control-flow">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword control-flow">await</span> port<span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//</span>
    <span class="token comment">// ここにswitchの状態による処理を書き足す</span>
    <span class="token comment">//</span>
	  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 500 ms 待機</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
            </section>
          </section>
        </section>
        <section class="level3" aria-labelledby="実行する-1">
          <h3 id="実行する-1">実行する</h3>
          <ul>
            <li>プロンプトが<code>pi@raspberrypi:~/myApp$</code>となっていることを確認</li>
            <li>コンソールに、<code>node main-gpio-polling.js</code> [ENTER] と入力して実行。</li>
            <li>0.3秒おきにポート5の値がコンソールに表示されていきます。</li>
            <li>タクトスイッチを押してみます。</li>
            <li>タクトスイッチが押されると、<strong>0</strong>に変化します。</li>
            <li>終了は CTRL+c</li>
          </ul>
        </section>
      </section>
    </section>
  </body>
</html>
