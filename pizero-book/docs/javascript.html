<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>JavaScript</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../themes/packages/@vivliostyle/theme-techbook/theme.css">
  </head>
  <body>
    <section class="level1" aria-labelledby="javascript">
      <h1 id="javascript">JavaScript</h1>
      <p>
        標準化されたプログラミング言語の一種で、ウェブブラウザが代表的な実行環境です(プログラムコードを解釈して動作させるシステム)。CHIRIMENでもRasberry Pi及びmicro:bit版はウェブブラウザを実行環境として使用します。Raspberry Pi Zero版はNode.jsを実行環境として使っています。
        別名としてECMA Scriptと呼ばれることもあります。
      </p>
      <ul>
        <li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript">Mozilla Developer Networkの解説</a></li>
      </ul>
      <section class="level2" aria-labelledby="javascript-の基礎">
        <h2 id="javascript-の基礎">JavaScript の基礎</h2>
        <p>JavaScript に慣れていない人は、下記ページを参考にしてください。</p>
        <ul>
          <li>「JavaScript 初学者向け資料集」（第 13 章 予備知識参照）を参照してください。</li>
        </ul>
      </section>
      <section class="level2" aria-labelledby="javascriptコードライブラリの読み込み">
        <h2 id="javascriptコードライブラリの読み込み">JavaScriptコード・ライブラリの読み込み</h2>
        <section class="level3" aria-labelledby="ウェブアプリ-html-で読み込み">
          <h3 id="ウェブアプリ-html-で読み込み">ウェブアプリ： HTML で読み込み</h3>
          <p>Raspberry Pi Zero 版以外の CHIRIMEN はプログラムの起点はHTMLファイルです。（ウェブアプリ<span class="footnote"><a href="https://ja.wikipedia.org/wiki/%E3%82%A6%E3%82%A7%E3%83%96%E3%82%A2%E3%83%97%E3%83%AA">https://ja.wikipedia.org/wiki/ウェブアプリ</a></span>）ブラウザはまず HTML ファイルを読み込んだうえで、そこに書かれた内容で動きます。したがって作ったコードや必要なライブラリの読み込みは基本的に全てこの HTML の中で指定します。（なお、 JavaScript Module を有効化している場合は JavaScript コードの中で JavaScript ライブラリを読み込むことがある）</p>
          <p>
            ポイントは <code>&#x3C;script ...>&#x3C;/script></code> の部分です。
            <code>polyfill.js</code> という JavaScript ライブラリを読み込んでいます。これは <a href="http://browserobo.github.io/WebGPIO">Web GPIO API</a> と、<a href="http://browserobo.github.io/WebI2C">Web I2C API</a> という W3C でドラフト提案中の 2 つの API への <a href="https://developer.mozilla.org/ja/docs/Glossary/Polyfill">Polyfill (新しい API を未実装のブラウザでも同じコードが書けるようにするためのライブラリ)</a> で、最初に読み込むとそれ以降のコードで GPIO や I2C を操作する JavaScript API が使えるようになります。
          </p>
          <p>次の行にある <code>main.js</code> は、JavaScript のプログラム本体です。</p>
        </section>
        <section class="level3" aria-labelledby="nodejs-chirimen-raspberry-pi-zero版">
          <h3 id="nodejs-chirimen-raspberry-pi-zero版">Node.js (CHIRIMEN Raspberry Pi Zero版)</h3>
          <p>Raspberry Pi Zero版はプログラムの起点が自分が作った JavaScript コード自体になります。ブラウザの代わりに <a href="https://ja.wikipedia.org/wiki/Node.js">Node.js</a>というJavaScriptコードだけを解釈するソフト（JavaScript インタープリタ<span class="footnote"><a href="https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%BC%E3%83%97%E3%83%AA%E3%82%BF">https://ja.wikipedia.org/wiki/インタープリタ</a></span>）にコードを読み込ませて実行します。</p>
          <p>CHIRIMEN 環境のために必要なライブラリや I2C デバイスのドライバ（7.5. WebI2C とデバイスドライバ参照）は、次の ECMA Script Module という仕組みを使って読み込みます。</p>
          <hr class="page-wrap">
        </section>
        <section class="level3" aria-labelledby="javascript-module-ecma-script-module">
          <h3 id="javascript-module-ecma-script-module">JavaScript Module (ECMA Script Module)</h3>
          <ul>
            <li>ウェブアプリでの Module 有効化： HTML の script 要素でJavaScriptを読み込むときは、 <code>type="module"</code> プロパティを設定する。
              <pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre>
            </li>
            <li>import文で外部のライブラリを読み込む。
              <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span><span class="token maybe-class-name">RelayServer</span><span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"https://chirimen.org/remote-connection/js/beta/RelayServer.js"</span><span class="token punctuation">;</span></code></pre>
            </li>
            <li>importされるライブラリ側には、importできるオブジェクトを指定するexport文を記述する。
              <pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token exports"><span class="token punctuation">{</span><span class="token maybe-class-name">RelayServer</span><span class="token punctuation">}</span></span><span class="token punctuation">;</span></code></pre>
            </li>
            <li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Modules">Mozilla Developer Networkの解説</a></li>
          </ul>
        </section>
      </section>
      <section class="level2" aria-labelledby="非同期処理">
        <h2 id="非同期処理">非同期処理</h2>
        <p>
          物理デバイス制御やネットワーク通信などでは、応答待ち中にブラウザが停止しないよう非同期処理を使う必要があります。
          本チュートリアルではこれを <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/async_function">async 関数</a> で記述しています。 async 関数による非同期処理に慣れていない人は、<a href="https://tutorial.chirimen.org/js/async">こちらの資料「非同期処理 (async await 版)」</a> も参考にしてください。非同期処理についてより詳しくは <a href="https://jsprimer.net/basic/async/">JS Primer の非同期処理説明ページ</a> をご覧ください。
        </p>
        <p>非同期処理を使いこなすのは難しいですが、本チュートリアルでは次のルールでコードを書けば大丈夫です:</p>
        <ul>
          <li><strong>非同期関数の呼び出し時には前に <code>await</code> を付けて呼び出す</strong>
            <ul>
              <li>非同期関数呼び出し前に <code>await</code> を付けると、その処理の完了を待ってから次のコードが実行されます</li>
              <li>GPIO/I2C の初期化、ポートの設定などは非同期処理なので <code>await</code> キーワードを付けて呼び出します</li>
            </ul>
          </li>
          <li><strong>非同期処理を含む関数は前に <code>async</code> を付けて非同期関数として定義する</strong>
            <ul>
              <li><code>async function 関数名() { ... }</code> のように頭に <code>async</code> を付けるだけで非同期関数になります</li>
            </ul>
          </li>
        </ul>
        <p>非同期関数を <code>await</code> なしで呼び出すと返り値が Promise オブジェクトとなり、 Promise を理解しないと返り値の判断や実行順序が入れ替わり意図せぬ挙動になります。例えば、ポートの初期化を <code>await</code> なしで呼ぶと、ポート初期化前に初期化未完了のハードウェアを操作しようとして失敗したりします。</p>
        <p>ハードウェアを制御するときは基本的に非同期呼び出しをする (その処理を含む関数もまた非同期で呼びす) と決めておけば迷うことなく、コードの実行順序も上から下に見たとおりの順番で実行され読み書きしやすくなります。</p>
      </section>
    </section>
  </body>
</html>
