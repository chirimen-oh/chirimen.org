<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>12. I2C</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../themes/packages/@vivliostyle/theme-techbook/theme.css">
  </head>
  <body>
    <section class="level1" aria-labelledby="12-i2c">
      <h1 id="12-i2c">12. I2C</h1>
      <section class="level2" aria-labelledby="121-i2cの概要">
        <h2 id="121-i2cの概要">12.1. I2Cの概要</h2>
        <p><a href="https://ja.wikipedia.org/wiki/I2C">I2C</a> とは 2 線式の同期式シリアル通信インタフェースです。「アイ・スクエア・シー」や「アイ・ ツー・シー」と読みます。I2C では SDA（シリアルデータ）と SCL（シリアルクロック）の 2 本の線で通信を行います。</p>
        <figure>
          <img src="../../raspi/imgs/section2/i2c-bus.png" alt="i2c-bus">
          <figcaption aria-hidden="true">i2c-bus</figcaption>
        </figure>
        <p>上図のように、I2C の SDA、SCL は複数のデバイス間で共有され、これを「I2C バス」と言います。I2C ではマスターとスレーブの間で通信が行われます。常にマスター側からスレーブ側に要求が行われ、スレーブ側からマスター側へ要求を行うことはできません。</p>
        <p>本チュートリアルでいえばCHIRIMEN環境を動かすボードコンピュータがマスターとなり、ここに接続されるセンサーやアクチュエータデバイスなどがスレーブとして想定されます。スレーブデバイスの一例として<a href="../partslist">こちらに紹介</a>されているI2Cデバイスをご覧ください。</p>
        <p>
          マスターは、スレーブが持つ「SlaveAddress (スレーブアドレス)」を指定して、特定のスレーブとの通信を行います。このため、同じ I2C バス上に同じ SlaveAddress のスレーブを繋ぐことはできません。
          I2Cデバイスは小型のICチップデバイスとなっており、デバイスによってはSlaveAddressは製品ごとに固定されています。
        </p>
        <figure>
          <img src="../../raspi/imgs/section2/i2c-bus2.png" alt="i2c-bus2">
          <figcaption aria-hidden="true">i2c-bus2</figcaption>
        </figure>
        <p>通信するデバイス同士が同一基板上にない場合には、SDA、SCL の 2 本の通信線に加え電源や GND の線を加えて 4 本のケーブルを用いて接続するのが一般的です。電源電圧はデバイスに応じたものを繋ぐ必要があります。</p>
        <section class="level3" aria-labelledby="1211-raspberry-piのi2c端子">
          <h3 id="1211-raspberry-piのi2c端子">12.1.1 Raspberry PiのI2C端子</h3>
          <p>下図のSCL, SDAがI2C端子です（黄色の端子）</p>
          <figure>
            <img src="../../raspi/imgs/section0/Raspi3PIN.png" alt="Raspi PIN配置図" height="600">
            <figcaption aria-hidden="true">Raspi PIN配置図</figcaption>
          </figure>
        </section>
        <section class="level3" aria-labelledby="1212-raspverry-pi-zeroのi2c端子">
          <h3 id="1212-raspverry-pi-zeroのi2c端子">12.1.2. Raspverry Pi ZeroのI2C端子</h3>
          <p>　Raspberry PiのI2C端子と同じ配列です。</p>
          <hr class="page-wrap">
        </section>
      </section>
      <section class="level2" aria-labelledby="122-参考-i2c-に関する詳細情報">
        <h2 id="122-参考-i2c-に関する詳細情報">12.2. 参考: I2C に関する詳細情報</h2>
        <p>I2C に関する詳細は下記をご参照ください。</p>
        <ul>
          <li><a href="https://ja.wikipedia.org/wiki/I2C">I2C</a> - Wikipedia</li>
          <li>I2C バス仕様書 最新版（<a href="https://www.nxp.com/docs/ja/user-guide/UM10204.pdf">日本語</a>、<a href="http://www.nxp.com/documents/user_manual/UM10204.pdf">English</a>）</li>
          <li><a href="http://www.picfun.com/i2cframe.html">I2C の使い方</a>（後閑哲也氏サイト）</li>
        </ul>
      </section>
      <section class="level2" aria-labelledby="123-ポイント">
        <h2 id="123-ポイント">12.3. ポイント</h2>
        <p>I2C の概要として下記を押さえておきましょう。</p>
        <ul>
          <li>I2C バスを介して複数のデバイスが繋がる</li>
          <li>I2C デバイスにはマスターとスレーブがある</li>
          <li>I2C ではマスターからスレーブに対して通信要求が行われる</li>
          <li>I2C スレーブは SlaveAddress を持つ</li>
          <li>同じ I2C バスに同じ SlaveAddress のデバイスは繋げない</li>
        </ul>
      </section>
      <section class="level2" aria-labelledby="124-i2cデバイスの実例i2c-温湿度センサー-sht30-sht31">
        <h2 id="124-i2cデバイスの実例i2c-温湿度センサー-sht30-sht31">12.4. I2Cデバイスの実例：I2C 温湿度センサー (SHT30, SHT31)</h2>
        <p>
          I2C に対応したデバイスの実例を見てみましょう。CHIRIMENでは <a href="../partslist#i2c-">Examples</a> にセンサーなど、いくつかの I2C デバイスを使うサンプルコードと Raspi との接続方法を示す回路図が提供されており、SHT30/SHT31も紹介されて
          います。
        </p>
        <section class="level3" aria-labelledby="1241-sht30-sht31について">
          <h3 id="1241-sht30-sht31について">12.4.1. SHT30, SHT31について</h3>
          <ul>
            <li><a href="http://akizukidenshi.com/catalog/g/gK-12125/">湿度・温度センサ (SHT31)</a> x 1
              <ul>
                <li>または SHT30 (<a href="https://www.amazon.co.jp/s?k=sht30">Amazon</a>, <a href="https://ja.aliexpress.com/item/32962846003.html">AliExpress</a>)。</li>
                <li>note: SHT31 は氷点下や 65 度以上などの高温での計測時の精度が SHT30 よりも少し高いが室温程度ではほぼ同様の類似モデルです。同シリーズには他にも SHT35 などもありますがそちらは未検証です。 (参考: <a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">データシート</a>)</li>
              </ul>
            </li>
          </ul>
          <hr class="page-wrap">
        </section>
        <section class="level3" aria-labelledby="1242-i2cデバイスモジュールの接続について">
          <h3 id="1242-i2cデバイスモジュールの接続について">12.4.2. I2Cデバイスモジュールの接続について</h3>
          <p>I2Cデバイスは一般的に小さなチップ部品です。下の拡大写真で緑で囲んだものがSHT31の本体で 上下に出ている微細な端子を接続して使いますが、微細過ぎてプロトタイピングには向きません。そこでブレッドボードで使いやすい端子に変換したモジュールが販売されています。モジュールには<strong>赤で囲んだように端子名の記載</strong>があります。これを<strong>ホストのコンピュータの端子名と一致させて結線</strong>することでI2Cデバイスが正しく接続されます。(電源端子はVIN,V+,3V,VCCなど別名になっていることがあります)</p>
          <figure>
            <img src="../../microbit/imgs/SHT31ModulePin.jpg" alt="I2Cmodule" height="150">
            <figcaption aria-hidden="true">I2Cmodule</figcaption>
          </figure>
          <section class="level4" aria-labelledby="12421-注意-配線時のポイント">
            <h4 id="12421-注意-配線時のポイント">12.4.2.1. 注意: 配線時のポイント</h4>
            <p>
              配線の接続先やデバイスの基板の表裏など間違えないように注意してください。
              配線を間違えると、故障や怪我などの原因になることがあります。おかしいなと思ったら、すぐに外して、配線をきちんと確認しましょう。
            </p>
          </section>
        </section>
      </section>
      <section class="level2" aria-labelledby="125-i2cdetectで接続がうまくいったか確認する">
        <h2 id="125-i2cdetectで接続がうまくいったか確認する">12.5. i2cdetectで接続がうまくいったか確認する</h2>
        <p><code>i2cdetect</code> を使って SlaveAddress を確認し、正しく接続・認識できているか確かめてみましょう。ターミナルを起動して下記コマンドを入力してみてください。</p>
        <section class="level3" aria-labelledby="1251-コマンドラインから">
          <h3 id="1251-コマンドラインから">12.5.1. コマンドラインから</h3>
          <pre class="language-sh"><code class="language-sh">i2cdetect -y -r 1</code></pre>
          <p>(microbit版はコマンドラインがないので下記webAppを使いましょう)</p>
        </section>
        <section class="level3" aria-labelledby="1252-i2cdetect-webapp">
          <h3 id="1252-i2cdetect-webapp">12.5.2. i2cdetect webApp</h3>
          <section class="level4" aria-labelledby="12521-raspberry-pi">
            <h4 id="12521-raspberry-pi">12.5.2.1. Raspberry Pi</h4>
            <p>
              SlaveAddress を確認する i2cdetect には WebI2C(後述) を使って実装したwebApp版もあります。<a href="https://r.chirimen.org/i2cdetect">https://r.chirimen.org/i2cdetect</a> をご利用ください。ただし、WebI2C 版 i2cdetect を利用中は他のペ
              ージから I2C デバイスを操作できません。確認が済んだらタブを閉じるようにしましょう。
            </p>
          </section>
          <section class="level4" aria-labelledby="12522-raspberry-pizerow">
            <h4 id="12522-raspberry-pizerow">12.5.2.2. Raspberry PiZeroW</h4>
            <p>Raspberry PiZeroWでは、<a href="https://chirimen.org/PiZeroWebSerialConsole/PiZeroWebSerialConsole.html">ターミナルウィンド</a>⇒CHIRIMEN Panel⇒i2c detect　でコマンドラインのショートカットが使えます。</p>
            <hr class="page-wrap">
          </section>
        </section>
        <section class="level3" aria-labelledby="1253-i2c-detectの結果">
          <h3 id="1253-i2c-detectの結果">12.5.3. i2c detectの結果</h3>
          <p>正しく接続できていれば下記のように表示されるはずです。</p>
          <pre class="language-text"><code class="language-text">$ i2cdetect -y -r 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- 44 -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --</code></pre>
          <p><code>44</code>という表示が見えます。これは 16 進数表示であり、 <code>0x44</code> は SHT30 の SlaveAddress です。</p>
          <p>念のためSHT30のデータシートも確認してみましょう。</p>
          <blockquote>
            <table>
              <thead>
                <tr>
                  <th>SHT3x-DIS</th>
                  <th>I2C Address in Hex. representation</th>
                  <th>Condition</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>I2C address A</td>
                  <td>0x44 (default)</td>
                  <td>ADDR (pin 2) connected to logic low</td>
                </tr>
                <tr>
                  <td>I2C address B</td>
                  <td>0x45</td>
                  <td>ADDR (pin 2) connected to logic high</td>
                </tr>
              </tbody>
            </table>
            <p><strong>Table 8 I2C device addresses.</strong></p>
            <p><a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">SHT30 のデータシート p.9</a>より引用</p>
          </blockquote>
          <p>SHT30 は<code>0x44</code>がデフォルトの SlaveAddress で、ADDR ピンの HIGH/LOW により SlaveAddeess を <code>0x44</code> か <code>0x45</code> に変更できることがわかります。</p>
          <hr class="page-wrap">
        </section>
        <section class="level3" aria-labelledby="1254-認識されないとき">
          <h3 id="1254-認識されないとき">12.5.4. 認識されないとき</h3>
          <p>
            試しに I2C デバイスへの電源供給を止めて、認識されないケースをあえて確かめてみます。
            一度 RasPi の 3.3V に接続している線を抜いて、もう一度 <code>i2cdetect -y -r 1</code> を実行してみてください。
          </p>
          <pre class="language-text"><code class="language-text">$ i2cdetect -y -r 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --</code></pre>
          <p>
            <code>44</code> という表示が見つからなくなりました。このことによって間違いなく SHT30 の SlaveAddress が <code>0x44</code> となっていることを確認できました。
            確認できたら、先ほど外した 3.3V の線を戻して再び SHT30 に電源を供給して認識されるようにしておきましょう。
          </p>
        </section>
      </section>
      <section class="level2" aria-labelledby="126-webi2cとデバイスドライバ">
        <h2 id="126-webi2cとデバイスドライバ">12.6. WebI2Cとデバイスドライバ</h2>
        <p>CHIRIMENでは、GPIOインターフェースをWeb GPIOと呼ぶAPIで使用しました。I2Cインターフェースに接続されたスレーブデバイスは<a href="http://browserobo.github.io/WebI2C">Web I2C API</a>と呼ぶAPIによって使用することができます。</p>
        <p>
          しかしI2CスレーブデバイスはGPIOの先に繋げるデバイスと比べてずっと複雑な機能を持っています。実際にはそれは極小のコンピュータで、I2Cを通しデバイス専用のコマンドやデータを送受信（通信）し、固有の機能を利用します。
          このようなコードは、各デバイスのデータシートをよく読み込んだうえで書くことができます。これはかなり手間のかかる開発ですので簡単にデバイスが使用できるライブラリ(デバイスドライバ)があらかじめ用意されています。
        </p>
        <section class="level3" aria-labelledby="1261-デバイスドライバが用意されているi2cデバイスのリスト">
          <h3 id="1261-デバイスドライバが用意されているi2cデバイスのリスト">12.6.1. デバイスドライバが用意されているI2Cデバイスのリスト</h3>
          <p><a href="../partslist#i2c-">デバイスドライバが用意され簡単に利用できるI2Cデバイスのリスト</a></p>
          <p>よく利用される、30種類ぐらいの比較的安価なデバイス向けのドライバが用意されています。</p>
        </section>
        <section class="level3" aria-labelledby="1262-i2c-温湿度センサー-sht30-sht31の使用例">
          <h3 id="1262-i2c-温湿度センサー-sht30-sht31の使用例">12.6.2. I2C 温湿度センサー (SHT30, SHT31)の使用例</h3>
          <p>Raspberry Pi では、index.htmlの中で、Raspberry Pi Zero Wではmain.jsの中で以下のライブラリを読み込んでいます。</p>
          <ul>
            <li>WebI2C APIを使用できるようにするためのライブラリ( Raspberry Pi: <code>polyfill.js</code>, Raspberry Pi Zero W: xxx)です。</li>
            <li>( Raspberry Pi, Raspberry Pi Zero W: <code>@chirimen/sht30</code>)　このファイルは、Web I2C API を使って SHT30 との通信を行うための、SHT30用のデバイスドライバー (ハードウェアを操作する為のライブラリ) です。</li>
          </ul>
          <p><code>main.js</code> がドライバーライブラリを使ってこのアプリケーションの動作を記述している部分です。</p>
          <hr class="page-wrap">
          <section class="level4" aria-labelledby="12621-mainjs">
            <h4 id="12621-mainjs">12.6.2.1. main.js</h4>
            <p>次に、<code>main.js</code> の処理の流れを見てみましょう。</p>
            <pre class="language-js"><code class="language-js"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> temperatureDisplay <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">"temperatureDisplay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> humidityDisplay <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">"humidityDisplay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> i2cAccess <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token method function property-access">requestI2CAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> i2cAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sht30 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SHT30</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> humidity<span class="token punctuation">,</span> temperature <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    temperatureDisplay<span class="token punctuation">.</span><span class="token property-access">innerHTML</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token html language-html"><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>temperature<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span> ℃</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    humidityDisplay<span class="token punctuation">.</span><span class="token property-access">innerHTML</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token html language-html"><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>humidity<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span> %</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
            <p>
              ここで温度センサーの情報を定期的に取得し、画面に出力する処理が行われています。
              少し詳し解説してみます。
            </p>
            <section class="level5" aria-labelledby="126211-await-navigatorrequesti2caccess">
              <h5 id="126211-await-navigatorrequesti2caccess">12.6.2.1.1. await navigator.requestI2CAccess()</h5>
              <p>Web I2C API を利用するための <strong><code>I2CAccess</code> インタフェースを取得</strong> するための最初の API 呼び出しです。この関数も非同期処理ですので <code>await</code> で処理完了を待機し、その結果正しくインタフェースが取得されたら <code>i2cAccess</code> オブジェクトに保持します。</p>
            </section>
            <section class="level5" aria-labelledby="126212-i2caccessportsget">
              <h5 id="126212-i2caccessportsget">12.6.2.1.2. i2cAccess.ports.get()</h5>
              <p><code>I2CAccess.ports</code> は、利用可能な I2C ポートの一覧です。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> port <span class="token operator">=</span> i2cAccess<span class="token punctuation">.</span><span class="token property-access">ports</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>CHIRIMEN RasPi、RasPiZero、で利用可能な I2C ポート番号は<code>1</code>番だけです。ポート番号に<code>1</code> を指定して <strong><code>port</code> オブジェクトを取得</strong> しています。</p>
            </section>
            <section class="level5" aria-labelledby="126213-new-sht30port-0x44">
              <h5 id="126213-new-sht30port-0x44">12.6.2.1.3 new SHT30(port, 0x44)</h5>
              <p>ドライバーライブラリを使い <strong>SHT30 を操作する為のインスタンスを生成</strong> しています。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> sht30 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SHT30</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <hr class="page-wrap">
            </section>
            <section class="level5" aria-labelledby="126214-await-sht30init">
              <h5 id="126214-await-sht30init">12.6.2.1.4. await sht30.init()</h5>
              <p>ドライバーライブラリのインスタンス (<code>sht30</code>) の <code>init()</code> メソッドを通じて <strong>I2C ポートを開いてセンサーを初期化</strong> しています。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>具体的に内部では、インスタンス生成時に指定した <code>port</code> オブジェクトと <code>slaveAddress(0x44)</code> を用いて <code>I2CPort.open()</code> を行なっています。<code>I2CPort.open()</code> が成功すると、<code>I2CSlaveDevice</code> という I2C ポートへデータ書き込みや読み込みなどを行うインタフェースが返されます。<code>I2CSlaveDevice</code> インタフェースは、ライブラリ内に保存され、その後の処理でこのインターフェイスを使って I2C デバイス SHT30 との通信が可能になります。</p>
            </section>
            <section class="level5" aria-labelledby="126215-await-sht30readdata">
              <h5 id="126215-await-sht30readdata">12.6.2.1.5. await sht30.readData()</h5>
              <p>これで実際にデータを読み取っています。 この読み取り関数はGPIOで紹介した、一回きりの単純入力に相当するものです。そのため連続的な変化を知りたい場合はポーリングルーチンを組む必要がありますね。</p>
              <p><strong>SHT30 の仕様に基づくデータ読み出し処理です</strong>。</p>
              <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> humidity<span class="token punctuation">,</span> temperature <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> sht30<span class="token punctuation">.</span><span class="token method function property-access">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
              <p>ドライバーライブラリ内部では、SHT30 から得られる温度と湿度それぞれ 16bit の数値を、温度・湿度の物理量の数値に変換して返却しています。</p>
            </section>
          </section>
          <section class="level4" aria-labelledby="12622-web-i2c-api-に着目して流れをまとめると">
            <h4 id="12622-web-i2c-api-に着目して流れをまとめると">12.6.2.2. Web I2C API に着目して流れをまとめると</h4>
            <ol>
              <li><strong>I2C の準備:</strong> <code>await navigator.requestI2CAccess()</code> で I2CAccess インタフェースを取得</li>
              <li><strong>ポートの準備:</strong> <code>await i2cAccess.ports.get(1)</code> で、1 番ポートの <code>port</code> オブジェクトを取得</li>
              <li><strong>デバイス初期化:</strong> <code>await port.open(0x44)</code> で、SlaveAddress <code>0x44</code> 番の I2CSlaveDevice インタフェースを取得</li>
              <li><strong>データ読み込み・書き込み:</strong></li>
            </ol>
            <p>この流れは他の I2C デバイスでも基本的に同様になります。</p>
            <hr class="page-wrap">
          </section>
        </section>
        <section class="level3" aria-labelledby="127-デバイスドライバーなしにsht30を使う">
          <h3 id="127-デバイスドライバーなしにsht30を使う">12.7. デバイスドライバーなしにSHT30を使う</h3>
          <p>デバイスドライバーはI2Cデバイスを簡単に使えるようにするライブラリでしかありませんので、ライブラリなしにWebI2CAPIを用いて直接デバイスを使うこともできます。運悪くデバイスドライバーが用意されていないI2Cデバイスを使いたい場合や、デバイスドライバーで省略されている機能を使いたい場合などのために、<a href="http://browserobo.github.io/WebI2C">Web I2C API</a>の振る舞いを理解しておきましょう。</p>
          <p>まず、デバイスドライバーなしに使うにはそのデバイスのデータシートをよく読み込みながら開発する必要があります。</p>
          <p>それでは<a href="https://github.com/chirimen-oh/chirimen-drivers/tree/master/packages/sht30/sht30.js">SHT30ドライバのコード</a>を見てみましょう。</p>
          <ul>
            <li>初期化 <code>init()</code></li>
          </ul>
          <pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slaveAddress<span class="token punctuation">)</span><span class="token punctuation">{</span>
		slaveAddress <span class="token operator">=</span> <span class="token number">0x44</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
          <p><a href="https://www.sensirion.com/fileadmin/user_upload/customers/sensirion/Dokumente/2_Humidity_Sensors/Datasheets/Sensirion_Humidity_Sensors_SHT3x_Datasheet_digital.pdf">SHT30データシート</a> の９ページに記載の通り、ドライバでは指定がない場合スレーブアドレス0x44を指定して通信を開始しています。</p>
          <ul>
            <li>データの読み取り <code>readData()</code></li>
          </ul>
          <pre class="language-js"><code class="language-js"><span class="token comment">// 単発高精度計測指示コマンドをi2cインターフェースに送信（</span>
<span class="token comment">// データシート９～１０ページ、及び２ページ（計測精度スペック））</span>
<span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">i2cSlave</span><span class="token punctuation">.</span><span class="token method function property-access">write8</span><span class="token punctuation">(</span><span class="token number">0x2C</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 計測完了の待機時間(100ms)</span>
<span class="token comment">//（データシート７ページ～15ms以上の待機）</span>
<span class="token keyword control-flow">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// i2cインターフェースから、６バイトの計測データを読み取り</span>
<span class="token comment">//（データシート１０ページ）</span>
<span class="token keyword">var</span> mdata <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">i2cSlave</span><span class="token punctuation">.</span><span class="token method function property-access">readBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 計算式（データシート１４ページ）に従い温度（摂氏）を算出</span>
<span class="token keyword">var</span> cTemp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> mdata<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">175</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65535.0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">45</span><span class="token punctuation">;</span>
<span class="token comment">// 同様に湿度（％）を算出</span>
<span class="token keyword">var</span> humidity <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span>mdata<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> mdata<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">65535.0</span><span class="token punctuation">;</span></code></pre>
          <p>ドライバーライブラリ内部では、上記のようにSHT30 に単発の高精度計測を指示し、得られた温度と湿度それぞれ 16bit の数値を、温度・湿度の物理量の浮動小数点数に変換して返却しています。</p>
        </section>
      </section>
    </section>
  </body>
</html>
